# YORI v0.2.1 Test Plan - HTTP/HTTPS Proxy Server

**Version:** 0.2.1 (Proxy Server)
**Date:** 2026-01-28
**Focus:** HTTP/HTTPS proxy with enforcement integration
**Estimated Time:** 1-2 hours

---

## Overview

v0.2.1 adds a complete HTTP/HTTPS reverse proxy server for intercepting LLM API traffic. This test plan validates the proxy functionality, not the enforcement features (already tested in v0.2.0).

**What's New in v0.2.1:**
- FastAPI-based reverse proxy server
- TLS termination and HTTPS support
- Request forwarding to upstream APIs (OpenAI, Anthropic)
- EnforcementEngine integration
- Block page HTML rendering
- Comprehensive audit logging
- CLI entry point: `python -m yori`

---

## Prerequisites

### Environment Setup

```bash
# 1. Install YORI v0.2.1
cd ~/Source/yori
git checkout cz1/release/v0.2.1  # or main after merge
pip install -e .

# 2. Verify installation
python -c "import yori; print('✅ YORI installed')"
python -m yori --help

# 3. Create test directories
mkdir -p /tmp/yori-v0.2.1-test/{certs,data}

# 4. Generate test TLS certificates
openssl req -x509 -newkey rsa:2048 -nodes \
  -keyout /tmp/yori-v0.2.1-test/certs/yori.key \
  -out /tmp/yori-v0.2.1-test/certs/yori.crt \
  -days 365 -subj "/CN=localhost"
```

### Test Configuration File

```bash
cat > /tmp/yori-v0.2.1-test/config.yaml << 'EOF'
mode: observe
listen: 0.0.0.0:8443

endpoints:
  - domain: api.openai.com
    enabled: true
  - domain: api.anthropic.com
    enabled: true

audit:
  database: /tmp/yori-v0.2.1-test/data/audit.db
  retention_days: 365

enforcement:
  enabled: false
  consent_accepted: false
EOF
```

---

## Test Suite

### Phase 1: Basic Proxy Functionality (20 minutes)

#### Test 1.1: Proxy Starts Successfully

**Objective:** Verify proxy server starts and listens

```bash
# Start proxy in background
python -m yori \
  --config /tmp/yori-v0.2.1-test/config.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key \
  --verbose &

PROXY_PID=$!
sleep 2

# Check if running
ps -p $PROXY_PID > /dev/null && echo "✅ Proxy running (PID: $PROXY_PID)" || echo "❌ Proxy failed to start"

# Check listening on port
lsof -i :8443 || ss -tlnp | grep 8443
echo "✅ Proxy listening on port 8443"
```

**Expected:** Proxy starts without errors, listens on port 8443

**Cleanup:**
```bash
kill $PROXY_PID
```

---

#### Test 1.2: Health Endpoint

**Objective:** Verify health check endpoint works

```bash
# Start proxy
python -m yori \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Test health endpoint
curl -k https://localhost:8443/health

# Should return 200 OK with health status
echo "✅ Health endpoint responds"

kill $PROXY_PID
```

**Expected:** Returns 200 with JSON health status

---

#### Test 1.3: Request Forwarding (Observe Mode)

**Objective:** Verify proxy forwards requests to upstream

```bash
# Start proxy
python -m yori \
  --config /tmp/yori-v0.2.1-test/config.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Make a request through proxy (will fail with 401 from OpenAI, but that's OK)
curl -k -v -X POST https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-test-fake-key" \
  -d '{
    "model": "gpt-3.5-turbo",
    "messages": [{"role": "user", "content": "Hello"}]
  }'

# Should get 401 from OpenAI (not 502/504 from proxy)
echo "✅ Request forwarded to upstream"

kill $PROXY_PID
```

**Expected:** Receives 401 from OpenAI (proves forwarding works)

---

#### Test 1.4: HTTP Method Support

**Objective:** Verify all HTTP methods work

```bash
# Start proxy
python -m yori \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Test GET
curl -k https://localhost:8443/health
echo "✅ GET works"

# Test POST
curl -k -X POST https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" -d '{}'
echo "✅ POST works"

# Test OPTIONS (CORS preflight)
curl -k -X OPTIONS https://localhost:8443/v1/chat/completions
echo "✅ OPTIONS works"

kill $PROXY_PID
```

**Expected:** All HTTP methods accepted

---

### Phase 2: Error Handling (15 minutes)

#### Test 2.1: Upstream Timeout Handling

**Objective:** Verify proxy handles upstream timeouts

```bash
# Start proxy with short timeout
python -m yori \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Test with endpoint that will timeout (invalid host)
curl -k -X POST https://localhost:8443/timeout-test \
  -H "Content-Type: application/json" \
  --max-time 10

# Should get 504 Gateway Timeout
echo "✅ Timeout handled with 504"

kill $PROXY_PID
```

**Expected:** Returns 504 Gateway Timeout

---

#### Test 2.2: Upstream Connection Error

**Objective:** Verify proxy handles connection failures

```bash
# Start proxy
python -m yori \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Make request that will fail to connect
# (In observe mode, all requests forward - some may fail)
curl -k -X POST https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" -d '{}'

# Check response code
echo "✅ Connection error handled"

kill $PROXY_PID
```

**Expected:** Returns appropriate error code (502/504)

---

#### Test 2.3: Invalid JSON Body

**Objective:** Verify proxy handles malformed requests

```bash
# Start proxy
python -m yori \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Send invalid JSON
curl -k -X POST https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d 'invalid json here'

# Should still forward to upstream (not proxy's job to validate)
echo "✅ Invalid JSON handled"

kill $PROXY_PID
```

**Expected:** Forwards to upstream, lets upstream validate

---

### Phase 3: TLS and HTTPS (15 minutes)

#### Test 3.1: TLS Certificate Loading

**Objective:** Verify proxy loads TLS certificates correctly

```bash
# Test with valid certificate
python -m yori \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Verify HTTPS works
curl -k https://localhost:8443/health
echo "✅ TLS certificate loaded"

kill $PROXY_PID
```

**Expected:** Proxy starts with TLS, HTTPS requests work

---

#### Test 3.2: Missing Certificate Handling

**Objective:** Verify proxy fails gracefully without certificates

```bash
# Try to start without cert
python -m yori 2>&1 | grep -i "certificate\|cert\|tls"

# Should show error or warning about missing cert
echo "✅ Missing certificate detected"
```

**Expected:** Error message about missing certificate

---

#### Test 3.3: HTTP-only Mode (--no-tls)

**Objective:** Verify HTTP-only mode for testing

```bash
# Start in HTTP mode
python -m yori --no-tls --port 8080 &

PROXY_PID=$!
sleep 2

# Test with HTTP (not HTTPS)
curl http://localhost:8080/health
echo "✅ HTTP-only mode works"

kill $PROXY_PID
```

**Expected:** Proxy listens on HTTP port

---

### Phase 4: Enforcement Integration (20 minutes)

#### Test 4.1: Enforcement Disabled (Observe Mode)

**Objective:** Verify observe mode never blocks

```bash
# Create observe mode config
cat > /tmp/yori-v0.2.1-test/observe.yaml << 'EOF'
mode: observe
enforcement:
  enabled: false
EOF

# Start proxy
python -m yori \
  --config /tmp/yori-v0.2.1-test/observe.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Make multiple requests - none should be blocked
for i in {1..5}; do
  curl -k -X POST https://localhost:8443/v1/chat/completions \
    -H "Content-Type: application/json" -d '{}' &
done
wait

echo "✅ Observe mode doesn't block"

kill $PROXY_PID
```

**Expected:** All requests forwarded, none blocked

---

#### Test 4.2: Enforcement Enabled (Block Mode)

**Objective:** Verify enforcement mode blocks requests

```bash
# Create enforcement config
cat > /tmp/yori-v0.2.1-test/enforce.yaml << 'EOF'
mode: enforce
enforcement:
  enabled: true
  consent_accepted: true
policies:
  directory: /tmp/yori-v0.2.1-test/policies
  files:
    test_policy:
      enabled: true
      action: block
EOF

# Start proxy with enforcement
python -m yori \
  --config /tmp/yori-v0.2.1-test/enforce.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Make request - should be blocked
curl -k https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" -d '{}'

# Should get 403 with HTML block page
echo "✅ Enforcement blocks requests"

kill $PROXY_PID
```

**Expected:** Returns 403 with HTML block page

---

#### Test 4.3: Allowlist Bypass

**Objective:** Verify allowlisted IPs bypass enforcement

```bash
# Create config with allowlist
cat > /tmp/yori-v0.2.1-test/allowlist.yaml << 'EOF'
mode: enforce
enforcement:
  enabled: true
  consent_accepted: true
  allowlist:
    devices:
      - ip: "127.0.0.1"
        name: "localhost"
        enabled: true
policies:
  files:
    test_policy:
      enabled: true
      action: block
EOF

# Start proxy
python -m yori \
  --config /tmp/yori-v0.2.1-test/allowlist.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Request from localhost (allowlisted) - should NOT be blocked
curl -k https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" -d '{}'

# Should forward to upstream (not block)
echo "✅ Allowlist bypasses enforcement"

kill $PROXY_PID
```

**Expected:** Request forwarded (not blocked)

---

### Phase 5: Block Page Rendering (15 minutes)

#### Test 5.1: Block Page HTML

**Objective:** Verify block page contains required elements

```bash
# Start proxy with enforcement
python -m yori \
  --config /tmp/yori-v0.2.1-test/enforce.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Get block page HTML
RESPONSE=$(curl -k https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" -d '{}')

# Verify HTML elements
echo "$RESPONSE" | grep -i "blocked" && echo "✅ Contains 'blocked'"
echo "$RESPONSE" | grep -i "policy" && echo "✅ Contains 'policy'"
echo "$RESPONSE" | grep -i "<!DOCTYPE html>" && echo "✅ Valid HTML"

kill $PROXY_PID
```

**Expected:** HTML block page with policy info

---

#### Test 5.2: Block Page in Browser

**Objective:** Verify block page renders correctly in browser

```bash
# Start proxy
python -m yori \
  --config /tmp/yori-v0.2.1-test/enforce.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key

# Manual step: Open browser
# Navigate to: https://localhost:8443/v1/chat/completions
# (Accept self-signed certificate warning)

# Verify visually:
# - ✅ HTML page renders
# - ✅ Shows "Request Blocked" message
# - ✅ Shows policy name
# - ✅ Shows timestamp
# - ✅ CSS styling present
```

**Expected:** Styled HTML block page visible

---

### Phase 6: Audit Logging (15 minutes)

#### Test 6.1: Request Logging

**Objective:** Verify requests are logged to audit database

```bash
# Start proxy
python -m yori \
  --config /tmp/yori-v0.2.1-test/config.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Make several requests
for i in {1..3}; do
  curl -k -X POST https://localhost:8443/v1/chat/completions \
    -H "Content-Type: application/json" -d '{}' > /dev/null 2>&1
  sleep 1
done

kill $PROXY_PID

# Check audit database
sqlite3 /tmp/yori-v0.2.1-test/data/audit.db "SELECT COUNT(*) FROM request_events;"

echo "✅ Requests logged to database"
```

**Expected:** Database contains request logs

---

#### Test 6.2: Block Event Logging

**Objective:** Verify block events are logged

```bash
# Start proxy with enforcement
python -m yori \
  --config /tmp/yori-v0.2.1-test/enforce.yaml \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Make request that gets blocked
curl -k https://localhost:8443/v1/chat/completions \
  -H "Content-Type: application/json" -d '{}'

kill $PROXY_PID

# Check block events
sqlite3 /tmp/yori-v0.2.1-test/data/audit.db \
  "SELECT event_type, policy_name, reason FROM enforcement_events WHERE event_type='block';"

echo "✅ Block events logged"
```

**Expected:** Block event in database

---

#### Test 6.3: Response Logging with Duration

**Objective:** Verify response timing is logged

```bash
# Check response events
sqlite3 /tmp/yori-v0.2.1-test/data/audit.db \
  "SELECT request_id, duration_ms FROM response_events WHERE duration_ms IS NOT NULL LIMIT 5;"

echo "✅ Response duration logged"
```

**Expected:** Response events include timing

---

### Phase 7: CLI and Configuration (10 minutes)

#### Test 7.1: CLI Help

**Objective:** Verify CLI help displays correctly

```bash
python -m yori --help

# Should show all options
echo "✅ CLI help displays"
```

**Expected:** Help text with all options

---

#### Test 7.2: CLI Options

**Objective:** Verify all CLI options work

```bash
# Test config file
python -m yori --config /tmp/yori-v0.2.1-test/config.yaml --help

# Test custom port
python -m yori --port 9443 --help

# Test custom host
python -m yori --host 127.0.0.1 --help

# Test verbose
python -m yori --verbose --help

echo "✅ All CLI options recognized"
```

**Expected:** No errors with options

---

#### Test 7.3: Standalone Server Script

**Objective:** Verify proxy_server.py runs directly

```bash
# Run standalone script
python python/yori/proxy_server.py \
  --cert /tmp/yori-v0.2.1-test/certs/yori.crt \
  --key /tmp/yori-v0.2.1-test/certs/yori.key &

PROXY_PID=$!
sleep 2

# Test it works
curl -k https://localhost:8443/health

kill $PROXY_PID

echo "✅ Standalone script works"
```

**Expected:** Proxy runs from standalone script

---

## Test Results Summary

After completing all tests, tally results:

```markdown
# YORI v0.2.1 Test Report

**Date:** [DATE]
**Tester:** [NAME]
**Duration:** [TIME]

## Summary

- **Total Tests:** 18
- **Passed:** __
- **Failed:** __
- **Skipped:** __

## Phase Results

| Phase | Tests | Pass | Fail |
|-------|-------|------|------|
| Basic Proxy | 4 | __ | __ |
| Error Handling | 3 | __ | __ |
| TLS/HTTPS | 3 | __ | __ |
| Enforcement | 3 | __ | __ |
| Block Page | 2 | __ | __ |
| Audit Logging | 3 | __ | __ |
| CLI/Config | 3 | __ | __ |

## Issues Found

### Critical
- [None or list issues]

### Major
- [None or list issues]

### Minor
- [None or list issues]

## Status

✅ PASS - Ready for deployment
⚠️ PASS WITH ISSUES - Minor fixes needed
❌ FAIL - Major issues found

**Signature:** _____________
**Date:** _____________
```

---

## Cleanup

```bash
# Stop any running proxy
pkill -f "python -m yori"

# Remove test data
rm -rf /tmp/yori-v0.2.1-test

# Uninstall if needed
pip uninstall yori -y
```

---

## Notes

- Tests use self-signed certificates (browser warnings expected)
- Upstream API calls will fail with 401 (expected, proves forwarding works)
- Enforcement tests require valid policy configuration
- Some tests require manual browser verification

**Total estimated time: 1-2 hours**
